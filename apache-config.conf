# Load an MPM module
LoadModule mpm_event_module modules/mod_mpm_event.so

# Load necessary modules for proxying and rewriting
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
LoadModule rewrite_module modules/mod_rewrite.so

Listen 80

# Definição do Balancer para o Backend Spring Boot
<Proxy balancer://mybackendcluster>
    # 'backend' é o nome do seu serviço no docker-compose.yml
    # O Docker Swarm (replicas: 3) lida com o balanceamento para as instâncias internas
    BalancerMember http://backend:8080
    ProxySet lbmethod=byrequests # Método de balanceamento (round-robin por requisições)
    # ProxySet stickysession=JSESSIONID|ROUTEID # Use se precisar de sessões "sticky"
</Proxy>

<VirtualHost *:80>
    ServerName localhost # Ou o IP do seu servidor/host Docker

    # Redireciona todas as requisições que começam com /api para o cluster de backend
    ProxyPass /api/ balancer://mybackendcluster/
    ProxyPassReverse /api/ balancer://mybackendcluster/

    # Redireciona WebSocket para o cluster de backend
    ProxyPass /websocket/ balancer://mybackendcluster/websocket/
    ProxyPassReverse /websocket/ balancer://mybackendcluster/websocket/


    # --- Configuração para o Frontend (Opção 2: Serve os arquivos estáticos do Angular diretamente) ---
    DocumentRoot "/usr/local/apache2/htdocs/app"
    <Directory "/usr/local/apache2/htdocs/app">
        Require all granted
        AllowOverride All
        # Para roteamento de SPA (Single Page Application) como Angular
        # Isso garante que todas as rotas internas do Angular sejam redirecionadas para o index.html
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Remova o segundo bloco de RewriteEngine e ProxyPass/ProxyPassReverse redundantes daqui.
    # As regras de Rewrite e os ProxyPass/ProxyPassReverse já estão configurados acima.

    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 common
</VirtualHost>